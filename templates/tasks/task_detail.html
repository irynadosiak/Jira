{% extends 'base.html' %}

{% block content %}
<div class="card" style="padding: 48px 64px; margin: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 32px;">
        <h1 style="margin: 0; font-size: 32px; font-weight: 600; color: #111827;">{{ task.title }}</h1>
        <div style="display: flex; gap: 12px;">
            <a href="{% url 'tasks:task-update' task.pk %}" class="btn btn-secondary" style="background: #f0f9ff; color: #1e40af; border: 1px solid #dbeafe; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.2s;">Edit</a>
            <a href="{% url 'tasks:task-delete' task.pk %}" class="btn btn-danger" style="background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.2s;">Delete</a>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
        <div>
            <h3 style="margin-bottom: 20px; font-size: 20px; font-weight: 500; color: #202124;">Details</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr><td style="padding: 8px 0; font-weight: bold; width: 30%;">Status:</td><td>{{ task.get_status_display }}</td></tr>
                <tr><td style="padding: 8px 0; font-weight: bold;">Priority:</td><td>{{ task.get_priority_display }}</td></tr>
                <tr><td style="padding: 8px 0; font-weight: bold;">Assignee:</td><td>{% if task.assignee %}{{ task.assignee.get_full_name|default:task.assignee.username }}{% else %}Unassigned{% endif %}</td></tr>
                <tr><td style="padding: 8px 0; font-weight: bold;">Reporter:</td><td>{{ task.reporter.get_full_name|default:task.reporter.username }}</td></tr>
                <tr><td style="padding: 8px 0; font-weight: bold;">Estimate:</td><td>{{ task.estimate|default:"Not set" }} points</td></tr>
                <tr><td style="padding: 8px 0; font-weight: bold;">Due Date:</td><td>{{ task.due_date|date:"M d, Y"|default:"Not set" }}</td></tr>
                <tr><td style="padding: 8px 0; font-weight: bold;">Created:</td><td>{{ task.created_at|date:"M d, Y H:i" }}</td></tr>
                <tr><td style="padding: 8px 0; font-weight: bold;">Updated:</td><td>{{ task.updated_at|date:"M d, Y H:i" }}</td></tr>
            </table>
        </div>
        
        <div>
            <h3 style="margin-bottom: 20px; font-size: 20px; font-weight: 500; color: #202124;">Quick Actions</h3>
            <form method="post" action="{% url 'tasks:task-quick-update' task.pk %}">
                {% csrf_token %}
                {% if task.status == 'todo' %}
                    <button type="submit" name="status" value="in_progress" class="btn" style="background: #fef3c7; color: #d97706; border: 1px solid #fde68a; padding: 8px 16px; border-radius: 6px; margin: 5px 0; font-weight: 500; transition: all 0.2s;">Start Progress</button>
                {% elif task.status == 'in_progress' %}
                    <button type="submit" name="status" value="in_review" class="btn" style="background: #e0f2fe; color: #0284c7; border: 1px solid #b3e5fc; padding: 8px 16px; border-radius: 6px; margin: 5px 0; font-weight: 500; transition: all 0.2s;">Move to Review</button>
                    <button type="submit" name="status" value="done" class="btn" style="background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; padding: 8px 16px; border-radius: 6px; margin: 5px 0; font-weight: 500; transition: all 0.2s;">Mark as Done</button>
                    <button type="submit" name="status" value="blocked" class="btn" style="background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: 8px 16px; border-radius: 6px; margin: 5px 0; font-weight: 500; transition: all 0.2s;">Block</button>
                {% elif task.status == 'in_review' %}
                    <button type="submit" name="status" value="done" class="btn" style="background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; padding: 8px 16px; border-radius: 6px; margin: 5px 0; font-weight: 500; transition: all 0.2s;">Mark as Done</button>
                    <button type="submit" name="status" value="in_progress" class="btn" style="background: #fef3c7; color: #d97706; border: 1px solid #fde68a; padding: 8px 16px; border-radius: 6px; margin: 5px 0; font-weight: 500; transition: all 0.2s;">Back to Progress</button>
                {% elif task.status == 'blocked' %}
                    <button type="submit" name="status" value="in_progress" class="btn" style="background: #fef3c7; color: #d97706; border: 1px solid #fde68a; padding: 8px 16px; border-radius: 6px; margin: 5px 0; font-weight: 500; transition: all 0.2s;">Unblock</button>
                {% elif task.status == 'done' %}
                    <button type="submit" name="status" value="todo" class="btn btn-secondary" style="background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; margin: 5px 0; font-weight: 500; transition: all 0.2s;">Reopen</button>
                {% endif %}
            </form>
        </div>
    </div>
    
    {% if task.description %}
    <div style="margin-bottom: 40px;">
        <h3 style="margin-bottom: 20px; font-size: 20px; font-weight: 500; color: #202124;">Description</h3>
        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 24px; border-radius: 8px; white-space: pre-wrap; color: #374151; line-height: 1.6;">{{ task.description }}</div>
    </div>
    {% endif %}
    
    <!-- AI Features Section (Side by Side) -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 24px 0;">
        
        <!-- AI Summary Section -->
        <div class="summary-section" style="padding: 20px; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; color: #202124; display: flex; align-items: center; font-size: 16px;">
                    <i class="fas fa-brain" style="margin-right: 6px; color: #5f6368; font-size: 14px;"></i>
                    AI Summary
                </h4>
                <div style="display: flex; gap: 6px;">
                    <button id="generate-summary-btn" class="btn summary-btn-primary" style="background: #e0f2fe; color: #0277bd; border: 1px solid #b3e5fc; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 500; font-size: 12px; line-height: 1.3;">
                        <span id="btn-text">Generate</span>
                        <span id="btn-spinner" class="spinner-border spinner-border-sm" style="display: none; margin-left: 4px;"></span>
                    </button>
                    <button id="delete-summary-btn" class="btn summary-btn-danger" style="background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; padding: 8px 12px; border-radius: 6px; cursor: pointer; display: none; transition: all 0.3s; font-weight: 500; font-size: 12px; line-height: 1.3;">
                        <i class="fas fa-trash" style="font-size: 11px;"></i>
                    </button>
                </div>
            </div>
            
            <!-- Info message -->
            <div id="info-message" style="background: #e3f2fd; border: 1px solid #bbdefb; color: #1976d2; padding: 8px; border-radius: 4px; margin-bottom: 10px; display: none; font-size: 12px;">
                <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                <span>Generating...</span>
            </div>
            
            <div id="summary-content" style="background: white; padding: 14px; border-radius: 6px; border: 1px solid #e8eaed; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
                <p id="summary-text" style="color: #5f6368; margin: 0; line-height: 1.4; font-size: 13px;">
                    No summary available. Click "Generate" to create an AI summary.
                </p>
                <div id="summary-meta" style="margin-top: 8px; font-size: 11px; color: #6b7280; display: none; border-top: 1px solid #f0f0f0; padding-top: 8px;">
                    <i class="fas fa-clock" style="margin-right: 3px;"></i>
                    <span id="summary-timestamp"></span>
                    <span style="margin-left: 10px;">
                        <i class="fas fa-chart-bar" style="margin-right: 3px;"></i>
                        <span id="summary-tokens"></span> tokens
                    </span>
                </div>
            </div>
            
            <!-- Error/Success Messages -->
            <div id="summary-message" style="margin-top: 8px; padding: 8px; border-radius: 4px; display: none; font-size: 12px;">
                <span id="message-text"></span>
            </div>
        </div>
        
        <!-- AI Estimation Section -->
        <div class="estimation-section" style="padding: 20px; background: #fafbfc; border: 1px solid #e8eaed; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; color: #202124; display: flex; align-items: center; font-size: 16px;">
                    <i class="fas fa-calculator" style="margin-right: 6px; color: #5f6368; font-size: 14px;"></i>
                    AI Estimation
                </h4>
                <button id="get-estimation-btn" class="btn estimation-btn-primary" style="background: #e8f5e8; color: #2e7d32; border: 1px solid #c8e6c9; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 500; font-size: 12px; line-height: 1.3;">
                    <span id="estimation-btn-text">Get Estimate</span>
                    <span id="estimation-btn-spinner" class="spinner-border spinner-border-sm" style="display: none; margin-left: 4px;"></span>
                </button>
            </div>
            
            <!-- Info message -->
            <div id="estimation-info-message" style="background: #f0f9ff; border: 1px solid #dbeafe; color: #1e40af; padding: 8px; border-radius: 4px; margin-bottom: 10px; display: none; font-size: 12px;">
                <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                <span>Analyzing...</span>
            </div>
            
            <div id="estimation-content" style="background: white; padding: 14px; border-radius: 6px; border: 1px solid #e8eaed; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
                <p id="estimation-text" style="color: #5f6368; margin: 0; line-height: 1.4; font-size: 13px;">
                    No estimation available. Click "Get Estimate" for an AI effort estimate.
                </p>
            
                <!-- Estimation Details -->
                <div id="estimation-details" style="margin-top: 12px; display: none;">
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div style="background: #f0f9ff; padding: 10px; border-radius: 6px; flex: 1; text-align: center;">
                            <div style="font-weight: 500; color: #1e40af; margin-bottom: 4px; font-size: 11px;">HOURS</div>
                            <div id="estimated-hours" style="font-size: 1.4em; font-weight: 600; color: #1e40af;"></div>
                        </div>
                        <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; flex: 1; text-align: center;">
                            <div style="font-weight: 500; color: #16a34a; margin-bottom: 4px; font-size: 11px;">CONFIDENCE</div>
                            <div id="confidence-score" style="font-size: 1.4em; font-weight: 600; color: #16a34a;"></div>
                        </div>
                    </div>
                    
                    <!-- Detailed Reasoning -->
                    <details style="cursor: pointer; margin-top: 8px;">
                        <summary style="font-weight: 500; color: #1e40af; padding: 4px 0; font-size: 12px;">View Analysis</summary>
                        <div id="estimation-reasoning" style="background: #f9fafb; padding: 10px; margin-top: 6px; border-radius: 4px; white-space: pre-wrap; font-family: 'SF Mono', 'Monaco', monospace; font-size: 11px; line-height: 1.3; color: #374151; max-height: 120px; overflow-y: auto; border: 1px solid #e5e7eb;"></div>
                    </details>
                    
                    <!-- Similar Tasks (Simplified) -->
                    <div id="similar-tasks-section" style="margin-top: 8px; display: none;">
                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Similar tasks found</div>
                        <div id="similar-tasks-list" style="max-height: 80px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Error/Success Messages -->
            <div id="estimation-message" style="margin-top: 8px; padding: 8px; border-radius: 4px; display: none; font-size: 12px;">
                <span id="estimation-message-text"></span>
            </div>
        </div>
        
    </div>

<!-- Custom Confirm Modal -->
<div id="custom-confirm-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3 style="margin: 0; color: #202124; font-size: 18px; font-weight: 400;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 8px; color: #f59e0b;"></i>
                Confirm Action
            </h3>
        </div>
        
        <div class="modal-body">
            <div style="margin: 20px 0;">
                <p id="confirm-title" style="color: #111827; font-size: 15px; font-weight: 500; margin: 0 0 8px 0;"></p>
                <p id="confirm-message" style="color: #6b7280; font-size: 14px; line-height: 1.5; margin: 0;"></p>
            </div>
        </div>
        
        <div class="modal-actions">
            <button type="button" id="confirm-cancel-btn" class="btn-secondary" style="background: #f8f9fa; color: #495057; border: 1px solid #dee2e6;">
                Cancel
            </button>
            <button type="button" id="confirm-ok-btn" class="btn-primary" style="background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;">
                Delete
            </button>
        </div>
    </div>
</div>
    
    <div style="margin-top: 40px;">
        <h3 style="margin-bottom: 24px; font-size: 24px; font-weight: 500; color: #202124;">Activity History</h3>
        {% for activity in task.activities.all %}
        <div style="border-left: 3px solid #e8eaed; padding: 20px 0 20px 24px; margin: 20px 0; background: #fafbfc; border-radius: 0 8px 8px 0;">
            <div style="font-weight: 600; color: #1a73e8; font-size: 15px; margin-bottom: 8px;">{{ activity.get_activity_type_display }}</div>
            <div style="margin: 8px 0; color: #374151; line-height: 1.5;">{{ activity.description }}</div>
            <small style="color: #6b7280; font-size: 13px;">{{ activity.timestamp|date:"M d, Y H:i" }}{% if activity.user %} by {{ activity.user.username }}{% endif %}</small>
        </div>
        {% empty %}
        <p style="color: #6b7280; font-style: italic; padding: 20px; background: #f9fafb; border-radius: 8px; text-align: center;">No activity yet.</p>
        {% endfor %}
    </div>
</div>

<style>
/* AI Summary Section Styles */
.summary-section {
    transition: all 0.3s ease;
}

.summary-section:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.summary-btn-primary:hover {
    background: #b3e5fc !important;
    border-color: #81d4fa !important;
    color: #01579b !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(2, 119, 189, 0.15);
}

.summary-btn-danger:hover {
    background: #ffcdd2 !important;
    border-color: #ef9a9a !important;
    color: #b71c1c !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(198, 40, 40, 0.15);
}

.summary-btn-primary:disabled,
.summary-btn-danger:disabled {
    opacity: 0.6;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}

#summary-content {
    transition: all 0.3s ease;
}

#summary-text {
    transition: color 0.3s ease;
}

#info-message {
    animation: slideIn 0.3s ease-out;
}

/* Main Card Responsive Design */
.card {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    background: white;
}

/* Custom Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal-overlay.show {
    opacity: 1;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    max-width: 480px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
    transform: scale(0.9) translateY(-20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal-overlay.show .modal-content {
    transform: scale(1) translateY(0);
}

.modal-header {
    padding: 24px 24px 0 24px;
    border-bottom: none;
}

.modal-body {
    padding: 0 24px;
}

.modal-actions {
    padding: 16px 24px 24px 24px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.btn-primary, .btn-secondary {
    padding: 10px 24px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid;
}

.btn-primary:hover, .btn-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Button hover effects for all light colored buttons */
a.btn-secondary:hover {
    background: #dbeafe !important;
    border-color: #93c5fd !important;
    color: #1d4ed8 !important;
}

a.btn-danger:hover {
    background: #fecaca !important;
    border-color: #f87171 !important;
    color: #b91c1c !important;
}

/* Quick Actions button hover effects */
button[style*="background: #fef3c7"]:hover {
    background: #fde68a !important;
    border-color: #f59e0b !important;
    color: #92400e !important;
}

button[style*="background: #e0f2fe"]:hover {
    background: #bae6fd !important;
    border-color: #0ea5e9 !important;
    color: #0c4a6e !important;
}

button[style*="background: #f0fdf4"]:hover {
    background: #dcfce7 !important;
    border-color: #22c55e !important;
    color: #14532d !important;
}

button[style*="background: #fef2f2"]:hover {
    background: #fecaca !important;
    border-color: #f87171 !important;
    color: #991b1b !important;
}

button[style*="background: #f8f9fa"]:hover {
    background: #e9ecef !important;
    border-color: #adb5bd !important;
    color: #495057 !important;
}

@media (max-width: 768px) {
    .card {
        padding: 32px 24px !important;
        margin: 16px !important;
    }
    
    /* Stack AI sections vertically on mobile */
    .card > div[style*="grid-template-columns: 1fr 1fr"] {
        display: block !important;
    }
    
    .summary-section,
    .estimation-section {
        margin: 16px 0 !important;
        padding: 16px !important;
    }
    
    .summary-section h3,
    .estimation-section h3 {
        font-size: 1.2rem;
        margin-bottom: 10px !important;
    }
    
    .summary-section > div:first-child,
    .estimation-section > div:first-child {
        flex-direction: column;
        align-items: stretch !important;
        gap: 12px;
    }
    
    .summary-section button,
    .estimation-section button {
        width: 100%;
        margin-left: 0 !important;
        margin-bottom: 8px;
    }
    
    #summary-content,
    #estimation-content {
        padding: 16px !important;
    }
    
    #summary-meta {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 5px;
    }
    
    #summary-meta span:last-child {
        margin-left: 0 !important;
    }
}

@media (max-width: 480px) {
    .card {
        padding: 24px 16px !important;
        margin: 12px !important;
    }
    
    .summary-section,
    .estimation-section {
        margin: 16px 0;
        padding: 16px 12px !important;
    }
    
    #summary-content,
    #estimation-content {
        padding: 14px !important;
    }
    
    h1 {
        font-size: 24px !important;
    }
    
    .card h3 {
        font-size: 18px !important;
    }
}

/* AI Estimation Section Styles */
.estimation-section {
    transition: all 0.3s ease;
}

.estimation-section:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.estimation-btn-primary:hover {
    background: #c8e6c9 !important;
    border-color: #a5d6a7 !important;
    color: #1b5e20 !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(46, 125, 50, 0.15);
}

.estimation-btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}

#estimation-content {
    transition: all 0.3s ease;
}

#estimation-details {
    animation: slideIn 0.3s ease-out;
}

.similar-task-item {
    background: #fafbfc;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
}

.similar-task-item:hover {
    background: #f3f4f6;
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.similarity-bar {
    height: 6px;
    background: #f1f5f9;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
}

.similarity-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #3b82f6, #06b6d4);
    transition: width 0.4s ease;
}

/* Animation for loading spinner */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.spinner-border {
    animation: spin 1s linear infinite;
}

/* Message animations */
#summary-message,
#info-message {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Generating state */
.generating {
    position: relative;
    overflow: hidden;
}

.generating::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(26,115,232,0.1), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const generateBtn = document.getElementById('generate-summary-btn');
    const deleteBtn = document.getElementById('delete-summary-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const summaryText = document.getElementById('summary-text');
    const summaryMeta = document.getElementById('summary-meta');
    const summaryTimestamp = document.getElementById('summary-timestamp');
    const summaryTokens = document.getElementById('summary-tokens');
    const summaryMessage = document.getElementById('summary-message');
    const messageText = document.getElementById('message-text');
    const infoMessage = document.getElementById('info-message');
    const summarySection = document.querySelector('.summary-section');
    
    // API URLs
    const taskId = {{ task.id }};
    const summaryUrl = `/tasks/api/${taskId}/summary/`;
    const generateUrl = `/tasks/api/${taskId}/generate-summary/`;
    const estimationUrl = `/tasks/api/${taskId}/estimate/`;
    
    // Load existing summary on page load
    loadExistingSummary();
    
    // Event Listeners
    generateBtn.addEventListener('click', generateSummary);
    deleteBtn.addEventListener('click', deleteSummary);
    
    // Estimation Elements and Event Listeners
    const getEstimationBtn = document.getElementById('get-estimation-btn');
    const estimationBtnText = document.getElementById('estimation-btn-text');
    const estimationBtnSpinner = document.getElementById('estimation-btn-spinner');
    const estimationText = document.getElementById('estimation-text');
    const estimationDetails = document.getElementById('estimation-details');
    const estimatedHours = document.getElementById('estimated-hours');
    const confidenceScore = document.getElementById('confidence-score');
    const similarTasksSection = document.getElementById('similar-tasks-section');
    const similarTasksList = document.getElementById('similar-tasks-list');
    const estimationReasoning = document.getElementById('estimation-reasoning');
    const estimationMessage = document.getElementById('estimation-message');
    const estimationMessageText = document.getElementById('estimation-message-text');
    const estimationInfoMessage = document.getElementById('estimation-info-message');
    
    getEstimationBtn.addEventListener('click', getEstimation);
    
    function getCsrfToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }
    
    function showMessage(message, isError = false) {
        messageText.textContent = message;
        summaryMessage.style.display = 'block';
        summaryMessage.style.background = isError ? 'rgba(220,53,69,0.2)' : 'rgba(40,167,69,0.2)';
        summaryMessage.style.border = `1px solid ${isError ? 'rgba(220,53,69,0.5)' : 'rgba(40,167,69,0.5)'}`;
        
        // Hide message after 5 seconds
        setTimeout(() => {
            summaryMessage.style.display = 'none';
        }, 5000);
    }
    
    function setLoadingState(isLoading) {
        generateBtn.disabled = isLoading;
        deleteBtn.disabled = isLoading;
        
        if (isLoading) {
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
            infoMessage.style.display = 'block';
            summarySection.classList.add('generating');
        } else {
            btnText.style.display = 'inline-block';
            btnSpinner.style.display = 'none';
            infoMessage.style.display = 'none';
            summarySection.classList.remove('generating');
        }
    }
    
    function loadExistingSummary() {
        fetch(summaryUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else if (response.status === 404) {
                // No summary exists yet
                return null;
            }
            throw new Error('Failed to load summary');
        })
        .then(data => {
            if (data) {
                displaySummary(data);
                btnText.textContent = 'Regenerate Summary';
                deleteBtn.style.display = 'inline-block';
            }
        })
        .catch(error => {
            console.log('No existing summary found or error loading summary:', error);
            // This is expected when no summary exists yet
        });
    }
    
    function generateSummary() {
        setLoadingState(true);
        
        try {
            // Create WebSocket connection for summary generation
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/tasks/${taskId}/summary/`;
            const ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                // Send summary generation request
                ws.send(JSON.stringify({
                    action: 'generate_summary'
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'connection') {
                    console.log('WebSocket connected for summary generation');
                } else if (data.type === 'progress') {
                    // Update info message with progress
                    const infoSpan = infoMessage.querySelector('span');
                    if (infoSpan) {
                        infoSpan.textContent = data.message;
                    }
                } else if (data.type === 'success') {
                    // Extract summary data from the WebSocket response
                    displaySummary(data.summary);
                    btnText.textContent = 'Regenerate Summary';
                    deleteBtn.style.display = 'inline-block';
                    showMessage('Summary generated successfully!', false);
                    ws.close();
                } else if (data.type === 'error') {
                    console.error('Error generating summary:', data.message);
                    showMessage('Error generating summary: ' + data.message, true);
                    ws.close();
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                showMessage('WebSocket connection error. Please try again.', true);
            };
            
            ws.onclose = function(event) {
                setLoadingState(false);
                if (event.code !== 1000) {
                    console.error('WebSocket closed unexpectedly:', event.code, event.reason);
                    showMessage('Connection lost. Please try again.', true);
                }
            };
            
        } catch (error) {
            console.error('Error creating WebSocket:', error);
            showMessage('Error connecting to server: ' + error.message, true);
            setLoadingState(false);
        }
    }
    
    function deleteSummary() {
        showCustomConfirm(
            'Are you sure you want to delete this summary?',
            'This action cannot be undone.',
            () => {
                // User confirmed, proceed with deletion
                setLoadingState(true);
                
                fetch(summaryUrl, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Reset to initial state
                    summaryText.textContent = 'No summary available. Click "Generate Summary" to create an AI-powered summary of this task\'s activities.';
                    summaryText.style.color = '#5f6368';
                    summaryMeta.style.display = 'none';
                    btnText.textContent = 'Generate Summary';
                    deleteBtn.style.display = 'none';
                    showMessage(data.message || 'Summary deleted successfully!', false);
                })
                .catch(error => {
                    console.error('Error deleting summary:', error);
                    showMessage('Error deleting summary: ' + error.message, true);
                })
                .finally(() => {
                    setLoadingState(false);
                });
            }
        );
    }
    
    function displaySummary(data) {
        summaryText.textContent = data.summary_text;
        summaryText.style.color = '#202124';
        
        // Format and display metadata
        const createdDate = new Date(data.created_at);
        const updatedDate = new Date(data.updated_at);
        const isUpdated = createdDate.getTime() !== updatedDate.getTime();
        
        summaryTimestamp.textContent = isUpdated 
            ? `Updated ${updatedDate.toLocaleDateString()} at ${updatedDate.toLocaleTimeString()}`
            : `Created ${createdDate.toLocaleDateString()} at ${createdDate.toLocaleTimeString()}`;
        summaryTokens.textContent = data.token_usage || 0;
        summaryMeta.style.display = 'block';
    }
    
    // Estimation Functions
    function showEstimationMessage(message, isError = false) {
        estimationMessageText.textContent = message;
        estimationMessage.style.display = 'block';
        estimationMessage.style.background = isError ? 'rgba(220,53,69,0.2)' : 'rgba(40,167,69,0.2)';
        estimationMessage.style.border = `1px solid ${isError ? 'rgba(220,53,69,0.5)' : 'rgba(40,167,69,0.5)'}`;
        
        // Hide message after 5 seconds
        setTimeout(() => {
            estimationMessage.style.display = 'none';
        }, 5000);
    }
    
    function setEstimationLoadingState(isLoading) {
        getEstimationBtn.disabled = isLoading;
        
        if (isLoading) {
            estimationBtnText.style.display = 'none';
            estimationBtnSpinner.style.display = 'inline-block';
            estimationInfoMessage.style.display = 'block';
        } else {
            estimationBtnText.style.display = 'inline-block';
            estimationBtnSpinner.style.display = 'none';
            estimationInfoMessage.style.display = 'none';
        }
    }
    
    function getEstimation() {
        setEstimationLoadingState(true);
        
        try {
            // Create WebSocket connection for estimation
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/tasks/${taskId}/estimation/`;
            const ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                // Send estimation request
                ws.send(JSON.stringify({
                    action: 'estimate'
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'connection') {
                    console.log('WebSocket connected for estimation');
                } else if (data.type === 'progress') {
                    // Update info message with progress
                    const infoSpan = estimationInfoMessage.querySelector('span');
                    if (infoSpan) {
                        infoSpan.textContent = data.message;
                    }
                } else if (data.type === 'success') {
                    // Extract estimation data from the WebSocket response
                    displayEstimation(data.estimation);
                    showEstimationMessage('Estimation generated successfully!', false);
                    ws.close();
                } else if (data.type === 'error') {
                    console.error('Error getting estimation:', data.message);
                    showEstimationMessage('Error getting estimation: ' + data.message, true);
                    ws.close();
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                showEstimationMessage('WebSocket connection error. Please try again.', true);
            };
            
            ws.onclose = function(event) {
                setEstimationLoadingState(false);
                if (event.code !== 1000) {
                    console.error('WebSocket closed unexpectedly:', event.code, event.reason);
                }
            };
            
        } catch (error) {
            console.error('Error creating WebSocket:', error);
            showEstimationMessage('Error connecting to server: ' + error.message, true);
            setEstimationLoadingState(false);
        }
    }
    
    function displayEstimation(data) {
        // Hide initial text and show details
        estimationText.style.display = 'none';
        estimationDetails.style.display = 'block';
        
        // Display main metrics
        estimatedHours.textContent = `${data.estimated_hours}h`;
        confidenceScore.textContent = `${Math.round(data.confidence_score * 100)}%`;
        
        // Display similar tasks if available
        if (data.similar_tasks && data.similar_tasks.length > 0) {
            similarTasksSection.style.display = 'block';
            similarTasksList.innerHTML = '';
            
            data.similar_tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'similar-task-item';
                
                const similarityPercent = Math.round((task.similarity_score || 0) * 100);
                
                taskItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div style="color: #374151; font-size: 12px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">#${task.id}: ${task.title.length > 30 ? task.title.substring(0, 30) + '...' : task.title}</div>
                        <span style="background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-left: 8px; flex-shrink: 0;">
                            ${task.estimate}h
                        </span>
                    </div>
                    <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">
                        ${similarityPercent}% similar
                    </div>
                    <div class="similarity-bar">
                        <div class="similarity-fill" style="width: ${similarityPercent}%;"></div>
                    </div>
                `;
                
                similarTasksList.appendChild(taskItem);
            });
        } else {
            similarTasksSection.style.display = 'none';
        }
        
        // Display reasoning
        estimationReasoning.textContent = data.reasoning || 'No detailed reasoning available.';
        
        // Update button text
        estimationBtnText.textContent = 'Refresh Estimation';
    }
    
    // Custom Confirm Function
    function showCustomConfirm(title, message, onConfirm) {
        const confirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        
        // Show modal with animation
        confirmModal.style.display = 'flex';
        setTimeout(() => {
            confirmModal.classList.add('show');
        }, 10);
        
        // Handle actions
        const closeConfirm = () => {
            confirmModal.classList.remove('show');
            setTimeout(() => {
                confirmModal.style.display = 'none';
            }, 300);
        };
        
        // Remove existing event listeners
        confirmCancelBtn.onclick = null;
        confirmOkBtn.onclick = null;
        
        // Cancel button
        confirmCancelBtn.onclick = closeConfirm;
        
        // OK button
        confirmOkBtn.onclick = () => {
            closeConfirm();
            if (onConfirm) onConfirm();
        };
        
        // Close on overlay click
        confirmModal.onclick = (e) => {
            if (e.target === confirmModal) {
                closeConfirm();
            }
        };
        
        // Close on Escape key
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                closeConfirm();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
    }
});
</script>

{% endblock %}
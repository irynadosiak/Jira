{% extends 'base.html' %}

{% block title %}Home - Task Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Enhanced Hero Section -->
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-robot text-primary" style="font-size: 3.5rem;"></i>
            </div>
            <h1 class="display-4 fw-bold mb-3" style="color: #202124;">Intelligent Task Manager</h1>
            <p class="lead text-muted mb-4">Streamline your workflow with smart task management and intelligent automation features</p>
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="{% url 'tasks:task-list' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-list me-2"></i>View Tasks
                </a>
                <button type="button" class="btn btn-success btn-lg" onclick="showAICreateModal()">
                    <i class="fas fa-magic me-2"></i>Create with AI
                </button>
                <a href="{% url 'tasks:dashboard' %}" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-chart-bar me-2"></i>Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- AI Features Showcase -->
<div class="row justify-content-center mt-5">
    <div class="col-lg-10">
        <div class="text-center mb-5">
            <h2 class="h3 mb-3">Smart Automation Features</h2>
            <p class="text-muted">Enhance your productivity with intelligent task processing and analysis</p>
        </div>
        
        <div class="row g-4">
            <!-- AI Task Creation -->
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="fas fa-brain text-success fa-2x"></i>
                        </div>
                        <h5 class="card-title">Smart Task Creation</h5>
                        <p class="card-text text-muted">Describe your task in natural language and let our parser extract structure and details</p>
                        <button class="btn btn-success btn-sm" onclick="showAICreateModal()">
                            <i class="fas fa-plus me-1"></i>Try Now
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Estimation -->
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="fas fa-calculator text-info fa-2x"></i>
                        </div>
                        <h5 class="card-title">Smart Estimation</h5>
                        <p class="card-text text-muted">Get time estimates based on similar tasks and pattern analysis</p>
                        <button class="btn btn-info btn-sm" onclick="showEstimationDemo()">
                            <i class="fas fa-clock me-1"></i>Learn More
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Summaries -->
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="fas fa-file-alt text-warning fa-2x"></i>
                        </div>
                        <h5 class="card-title">Auto Summaries</h5>
                        <p class="card-text text-muted">Generate concise summaries of task progress and key activities</p>
                        <button class="btn btn-warning btn-sm" onclick="showSummaryDemo()">
                            <i class="fas fa-eye me-1"></i>Learn More
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Features Grid -->
<div class="row justify-content-center mt-5">
    <div class="col-lg-10">
        <div class="text-center mb-4">
            <h3 class="h4">Core Features</h3>
        </div>
        <div class="row g-4">
            <div class="col-md-6">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas fa-tasks text-primary fa-lg"></i>
                    </div>
                    <div>
                        <h5 class="mb-2">Smart Task Management</h5>
                        <p class="text-muted mb-0">Create, edit, and track tasks with AI-powered status updates and intelligent categorization</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas fa-search text-primary fa-lg"></i>
                    </div>
                    <div>
                        <h5 class="mb-2">Intelligent Search</h5>
                        <p class="text-muted mb-0">Advanced filtering by status, assignee, priority, and semantic text search</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas fa-chart-line text-primary fa-lg"></i>
                    </div>
                    <div>
                        <h5 class="mb-2">Analytics & Insights</h5>
                        <p class="text-muted mb-0">AI-powered analytics with automatic activity tracking and progress insights</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas fa-code text-primary fa-lg"></i>
                    </div>
                    <div>
                        <h5 class="mb-2">Developer-Friendly API</h5>
                        <p class="text-muted mb-0">Full REST API with AI endpoints for task creation, estimation, and summarization</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Interactive Demo Section -->
<div class="row justify-content-center mt-5">
    <div class="col-lg-8">
        <div class="text-center py-4">
            <h4 class="mb-3">Experience Smart Task Management</h4>
            <p class="text-muted mb-4">Try our intelligent features or explore existing tasks</p>
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                <button class="btn btn-success" onclick="showAICreateModal()">
                    <i class="fas fa-magic me-2"></i>Smart Create
                </button>
                <a href="{% url 'tasks:task-create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Manual Create
                </a>
                <a href="{% url 'tasks:task-list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-list me-2"></i>Browse Tasks
                </a>
            </div>
        </div>
    </div>
</div>

<!-- AI Create Task Modal -->
<div class="modal fade" id="aiCreateModal" tabindex="-1" aria-labelledby="aiCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiCreateModalLabel">
                    <i class="fas fa-magic me-2"></i>Smart Task Creation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="aiCreateForm">
                    <div class="mb-3">
                        <label for="aiTaskText" class="form-label">Describe your task in natural language:</label>
                        <textarea class="form-control" id="aiTaskText" rows="4" 
                                placeholder="Describe your task here..."></textarea>
                        <div class="form-text">Our smart parser will extract title, description, priority, due date, and estimate from your text.</div>
                    </div>
                    
                    <!-- Examples Section -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted fw-bold">ðŸ’¡ Try these examples:</small>
                            <button type="button" class="btn btn-link btn-sm p-0" onclick="clearTaskText()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                        <div class="examples-container">
                            <div class="example-item" onclick="useExample(this)">
                                <div class="example-text">
                                    <strong>Bug Fix:</strong> "Fix the critical login bug that's preventing users from accessing the dashboard. This is urgent priority and should take about 3-4 hours to complete by tomorrow."
                                </div>
                                <div class="example-tags">
                                    <span class="badge bg-danger">Critical</span>
                                    <span class="badge bg-info">Bug</span>
                                    <span class="badge bg-warning">3-4h</span>
                                </div>
                            </div>
                            
                            <div class="example-item" onclick="useExample(this)">
                                <div class="example-text">
                                    <strong>Feature:</strong> "Create a new user profile page with photo upload functionality. Medium priority feature that will require database changes and UI design, estimated 8-10 hours over next week."
                                </div>
                                <div class="example-tags">
                                    <span class="badge bg-warning">Medium</span>
                                    <span class="badge bg-success">Feature</span>
                                    <span class="badge bg-info">8-10h</span>
                                </div>
                            </div>
                            
                            <div class="example-item" onclick="useExample(this)">
                                <div class="example-text">
                                    <strong>Enhancement:</strong> "Improve the search functionality to include filters and sorting options. Low priority enhancement that should be completed within 2 weeks, roughly 5-6 hours of work."
                                </div>
                                <div class="example-tags">
                                    <span class="badge bg-secondary">Low</span>
                                    <span class="badge bg-primary">Enhancement</span>
                                    <span class="badge bg-warning">5-6h</span>
                                </div>
                            </div>
                            
                            <div class="example-item" onclick="useExample(this)">
                                <div class="example-text">
                                    <strong>Documentation:</strong> "Write API documentation for the new payment endpoints. Include examples and error codes. Should be done by end of week, approximately 2-3 hours."
                                </div>
                                <div class="example-tags">
                                    <span class="badge bg-info">Medium</span>
                                    <span class="badge bg-light text-dark">Documentation</span>
                                    <span class="badge bg-warning">2-3h</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="parseTaskText()">
                            <i class="fas fa-eye me-1"></i>Preview Parsing
                        </button>
                        <button type="button" class="btn btn-success" onclick="createTaskFromAI()">
                            <i class="fas fa-plus me-1"></i>Create Task
                        </button>
                    </div>
                </form>
                
                <!-- Preview Section -->
                <div id="parsePreview" class="mt-4" style="display: none;">
                    <hr>
                    <h6>Smart Parsing Preview:</h6>
                    <div id="parseResult" class="border p-3 rounded bg-light"></div>
                </div>
                
                <!-- Loading and Success States -->
                <div id="aiCreateLoading" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2 text-muted">Processing your request...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Demo Modals -->
<div class="modal fade" id="estimationDemoModal" tabindex="-1" aria-labelledby="estimationDemoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="estimationDemoModalLabel">
                    <i class="fas fa-calculator me-2"></i>Smart Estimation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Our estimation system analyzes:</p>
                <ul>
                    <li>Similar completed tasks</li>
                    <li>Task complexity indicators</li>
                    <li>Historical performance data</li>
                    <li>Pattern matching algorithms</li>
                </ul>
                <p class="text-muted">To see smart estimation in action, create or view existing tasks with the "Get Estimate" feature.</p>
                <div class="text-center">
                    <a href="{% url 'tasks:task-list' %}" class="btn btn-primary">
                        <i class="fas fa-list me-2"></i>View Tasks
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="summaryDemoModal" tabindex="-1" aria-labelledby="summaryDemoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="summaryDemoModalLabel">
                    <i class="fas fa-file-alt me-2"></i>Auto Summaries
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Auto summaries generate:</p>
                <ul>
                    <li>Concise progress overviews</li>
                    <li>Key activity highlights</li>
                    <li>Status change summaries</li>
                    <li>Action item extraction</li>
                </ul>
                <p class="text-muted">Summaries are generated as tasks progress and can be viewed in task details.</p>
                <div class="text-center">
                    <a href="{% url 'tasks:task-list' %}" class="btn btn-primary">
                        <i class="fas fa-list me-2"></i>Explore Tasks
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// AI Create Task Functions
function showAICreateModal() {
    const modal = new bootstrap.Modal(document.getElementById('aiCreateModal'));
    modal.show();
}

function showEstimationDemo() {
    const modal = new bootstrap.Modal(document.getElementById('estimationDemoModal'));
    modal.show();
}

function showSummaryDemo() {
    const modal = new bootstrap.Modal(document.getElementById('summaryDemoModal'));
    modal.show();
}

function useExample(element) {
    const exampleText = element.querySelector('.example-text').textContent;
    // Extract just the quoted text part
    const match = exampleText.match(/"([^"]+)"/);
    if (match) {
        document.getElementById('aiTaskText').value = match[1];
        // Scroll to textarea
        document.getElementById('aiTaskText').scrollIntoView({ behavior: 'smooth', block: 'center' });
        document.getElementById('aiTaskText').focus();
    }
}

function clearTaskText() {
    document.getElementById('aiTaskText').value = '';
    document.getElementById('parsePreview').style.display = 'none';
}

async function parseTaskText() {
    console.log('parseTaskText() called');
    const text = document.getElementById('aiTaskText').value.trim();
    console.log('Text to parse:', text.substring(0, 100) + '...');
    if (!text) {
        alert('Please enter some text to parse.');
        return;
    }

    const preview = document.getElementById('parsePreview');
    const result = document.getElementById('parseResult');
    
    // Show loading state
    result.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Parsing text with AI...
        </div>
    `;
    preview.style.display = 'block';
    
    try {
        // Create WebSocket connection for parsing
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/tasks/parse/`;
        const ws = new WebSocket(wsUrl);
        
        ws.onopen = function(event) {
            console.log('WebSocket connection opened for parsing');
            // Send parsing request
            ws.send(JSON.stringify({
                action: 'parse',
                text: text
            }));
            console.log('Sent parsing request:', text.substring(0, 100) + '...');
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'connection') {
                console.log('WebSocket connected for parsing');
            } else if (data.type === 'progress') {
                result.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        ${data.message}
                    </div>
                `;
            } else if (data.type === 'success') {
                const taskData = data.parsed_data;
                result.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Title:</strong> ${taskData.title}<br>
                            <strong>Priority:</strong> <span class="badge bg-${getPriorityColor(taskData.priority)}">${taskData.priority}</span><br>
                            <strong>Type:</strong> ${taskData.task_type}<br>
                            <strong>Estimate:</strong> ${taskData.estimate || 'Not specified'} SP
                        </div>
                        <div class="col-md-6">
                            <strong>Due Date:</strong> ${taskData.due_date || 'Not specified'}<br>
                            <strong>Confidence:</strong> ${(taskData.confidence_score * 100).toFixed(1)}%<br>
                            <strong>Tags:</strong> ${taskData.tags ? taskData.tags.join(', ') : 'None'}
                        </div>
                    </div>
                    <div class="mt-2">
                        <strong>Description:</strong><br>
                        <div class="text-muted">${taskData.description}</div>
                    </div>
                `;
                ws.close();
            } else if (data.type === 'error') {
                result.innerHTML = `<div class="alert alert-danger">${data.message || 'Parsing failed'}</div>`;
                ws.close();
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            console.error('WebSocket URL was:', wsUrl);
            result.innerHTML = `<div class="alert alert-danger">WebSocket connection error. Please try again.</div>`;
        };
        
        ws.onclose = function(event) {
            if (event.code !== 1000) {
                console.error('WebSocket closed unexpectedly:', event.code, event.reason);
            }
        };
        
    } catch (error) {
        result.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
}

async function createTaskFromAI() {
    const text = document.getElementById('aiTaskText').value.trim();
    if (!text) {
        alert('Please enter some text to create a task.');
        return;
    }

    const loading = document.getElementById('aiCreateLoading');
    loading.style.display = 'block';

    try {
        // Create WebSocket connection for task creation
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/tasks/create/`;
        const ws = new WebSocket(wsUrl);
        
        ws.onopen = function(event) {
            // Send task creation request
            ws.send(JSON.stringify({
                action: 'create',
                text: text
            }));
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'connection') {
                console.log('WebSocket connected for task creation');
            } else if (data.type === 'progress') {
                // Update loading message with progress
                const loadingDiv = document.querySelector('#aiCreateLoading .alert');
                if (loadingDiv) {
                    loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${data.message}`;
                }
            } else if (data.type === 'success') {
                // Success - redirect to the created task
                window.location.href = `/tasks/${data.task.id}/`;
            } else if (data.type === 'error') {
                loading.style.display = 'none';
                alert(`Error creating task: ${data.message || 'Unknown error'}`);
                ws.close();
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            loading.style.display = 'none';
            alert('WebSocket connection error. Please try again.');
        };
        
        ws.onclose = function(event) {
            if (event.code !== 1000) {
                console.error('WebSocket closed unexpectedly:', event.code, event.reason);
                loading.style.display = 'none';
                alert('Connection lost. Please try again.');
            }
        };
        
    } catch (error) {
        loading.style.display = 'none';
        alert(`Error: ${error.message}`);
    }
}

function getPriorityColor(priority) {
    const colors = {
        'low': 'secondary',
        'medium': 'warning',
        'high': 'danger',
        'critical': 'dark'
    };
    return colors[priority?.toLowerCase()] || 'secondary';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.examples-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
    background: #fafbfc;
}

.example-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.example-item:hover {
    border-color: #3b82f6;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    transform: translateY(-1px);
}

.example-item:last-child {
    margin-bottom: 0;
}

.example-text {
    font-size: 13px;
    line-height: 1.4;
    margin-bottom: 8px;
    color: #374151;
}

.example-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.example-tags .badge {
    font-size: 10px;
    padding: 2px 6px;
}

.examples-container::-webkit-scrollbar {
    width: 6px;
}

.examples-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.examples-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.examples-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

{% endblock %}